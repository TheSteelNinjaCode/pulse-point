import{parse}from"acorn";import{simple as walk}from"acorn-walk";import{PortalManager}from"./portal-manager.js";import{ComponentManager}from"./component-manager.js";import{DOMBindingManager}from"./dom-binding-manager.js";export const CONSTANTS={ATTR_PREFIXES:{COMPONENT:"pp-component",LOOP:"pp-for",SPREAD:"pp-spread",REF:"pp-ref",IGNORE:"pp-ignore"},SCRIPT_TYPE:"text/pp",MAX_CACHE_SIZE:2e3,DEBOUNCE_MS:16,MUSTACHE_PATTERN:/\{((?:[^{}]|\{(?:[^{}]|\{[^{}]*\})*\})*)\}/};export const RESERVED_WORDS=new Set(["true","false","null","undefined","this","window","document","console","Math","Date","JSON","Object","Array","return","let","const","var","if","else","for","while","switch","case","break","continue","function","new","in","of","typeof","instanceof","void","delete","try","catch","finally","class","extends","super","thisElement","eventObject","arguments"]);function debounce(e,t){let s;return(...n)=>{clearTimeout(s),s=window.setTimeout(()=>e(...n),t)}}export function capitalize(e){return e.charAt(0).toUpperCase()+e.slice(1)}export function valueToString(e){if(null==e||"boolean"==typeof e||"function"==typeof e)return"";if(Array.isArray(e)&&0===e.length)return"";if("object"==typeof e&&0===Object.keys(e).length)return"";if("number"==typeof e)return String(e);if("string"==typeof e)return e;if(Array.isArray(e)){if(e.some(e=>null!==e&&("object"==typeof e||Array.isArray(e))))try{return JSON.stringify(e)}catch{return"[Array]"}return e.map(e=>valueToString(e)).filter(e=>""!==e).join("")}if("object"==typeof e)try{return JSON.stringify(e)}catch{return"[object Object]"}return String(e)}export function isStateGetter(e){return"function"==typeof e&&"__pphp_key"in e}export function extractStateValue(e){return isStateGetter(e)?e.value:e}export function extractStateValueSmart(e,t={}){if(!isStateGetter(e))return e;const s=e.value;return t.forComparison||t.forLogical||t.forceExtract||null==s||"boolean"==typeof s||"string"==typeof s||"number"==typeof s?s:e}export function extractContextValues(e,t=!1){const s={};for(const[n,r]of Object.entries(e))isStateGetter(r)?s[n]=t?extractStateValueSmart(r):r.value:s[n]=r;return s}export function expressionNeedsValueExtraction(e){return e.includes("?")||e.includes("&&")||e.includes("||")||e.includes("===")||e.includes("!==")||e.includes("==")||e.includes("!=")||e.includes(">=")||e.includes("<=")||e.includes(">")||e.includes("<")||/^!/.test(e.trim())}var HydrationPhase;!function(e){e.NOT_STARTED="not_started",e.SCRIPTS_EXECUTING="scripts_executing",e.LOOPS_PROCESSING="loops_processing",e.EFFECTS_RUNNING="effects_running",e.PORTALS_RENDERING="portals_rendering",e.COMPLETE="complete"}(HydrationPhase||(HydrationPhase={}));export class ScopeChainRegistry{static instance;elementScopeChains=new WeakMap;static getInstance(){return ScopeChainRegistry.instance||(ScopeChainRegistry.instance=new ScopeChainRegistry),ScopeChainRegistry.instance}register(e,t){this.elementScopeChains.set(e,t)}get(e){return this.elementScopeChains.get(e)}findClosestRegistered(e){let t=e;for(;t;){const e=this.elementScopeChains.get(t);if(e)return e;t=t.parentElement}}clear(){this.elementScopeChains=new WeakMap}}class LifecycleManager{phase=HydrationPhase.NOT_STARTED;phasePromises=new Map;phaseResolvers=new Map;hooks={};constructor(){Object.values(HydrationPhase).forEach(e=>{const t=new Promise(t=>{this.phaseResolvers.set(e,t)});this.phasePromises.set(e,t)})}getCurrentPhase(){return this.phase}async waitForPhase(e){await this.phasePromises.get(e)}markPhaseComplete(e){this.phase=e;const t=this.phaseResolvers.get(e);t&&t(),this.emitPhaseEvent(e)}emitPhaseEvent(e){document.dispatchEvent(new CustomEvent(`pp:phase:${e}`,{detail:{phase:e,timestamp:performance.now()}}))}registerHooks(e){this.hooks={...this.hooks,...e}}async executeHook(e){const t=this.hooks[e];if(t)try{await Promise.resolve(t())}catch(t){console.error(`[Lifecycle] Hook ${e} failed:`,t)}}}export class ScopeResolver{static scopeCache=new WeakMap;static commentCache=new WeakMap;static trackedElements=new Set;static cleanupScheduled=!1;static CLEANUP_INTERVAL=5e3;static MAX_TRACKED_ELEMENTS=1e3;static lastCleanup=0;static findAllParentScopes(e){const t=[],s=e instanceof Text?e.parentElement:e;if(!s)return t;const n=ScopeChainRegistry.getInstance().findClosestRegistered(s);n&&t.push(...n);const r=this.findScope(s);if(r&&!t.includes(r)&&t.push(r),!n){let e=s.parentElement;for(;e&&e!==document.body;){const s=this.findScopeInSiblings(e);s&&!t.includes(s)&&t.push(s);const n=e.getAttribute(CONSTANTS.ATTR_PREFIXES.COMPONENT);n&&!t.includes(n)&&t.push(n),e=e.parentElement}}return t}static findScope(e){const t=e instanceof Text?e.parentElement:e;if(!t)return null;if(this.scopeCache.has(t))return this.scopeCache.get(t);const s=this.findScopeUncached(t);return this.scopeCache.set(t,s),this.trackElement(t),s}static findScopeUncached(e){const t=this.findScopeInSiblings(e);if(null!==t)return t;let s=e.parentElement;for(;s&&s!==document.body;){if(s instanceof Element&&s.hasAttribute(CONSTANTS.ATTR_PREFIXES.COMPONENT))return null;const e=this.findScopeInSiblings(s);if(null!==e)return e;s=s.parentElement}return null}static findScopeInSiblings(e){const t=e=>/^s[a-z0-9]{3,}$/i.test(e),s=e=>{return!!document.querySelector(`[pp-component="${t=e,globalThis.CSS?.escape?CSS.escape(t):t}"]`);var t};let n=e.previousSibling,r=0;for(;n;){if(n.nodeType===Node.COMMENT_NODE){const e=n,i=this.parseCommentNode(e,r);if(null!==i)if("end"===i.type)r++;else if("start"===i.type)if(0===r){if(!t(i.name))return i.name;if(s(i.name))return i.name}else r--}n=n.previousSibling}return null}static parseCommentNode(e,t){if(this.commentCache.has(e)){const t=this.commentCache.get(e);if(""===t)return null;if("/pp-scope"===t)return{type:"end",name:""};if(t.startsWith("pp-scope:")){return{type:"start",name:t.substring(9)}}}const s=(e.textContent||"").trim();if("/pp-scope"===s)return this.commentCache.set(e,s),{type:"end",name:""};if(s.startsWith("pp-scope:")){const t=s.substring(9).trim();return this.isValidScopeName(t)?(this.commentCache.set(e,s),{type:"start",name:t}):(console.warn(`‚ö†Ô∏è Invalid scope name in comment: "${t}". Scope names must be valid identifiers or "app".`),this.commentCache.set(e,""),null)}return this.commentCache.set(e,""),null}static isValidScopeName(e){return"app"===e||/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(e)}static removeScopeComments(){const e=document.createTreeWalker(document.body,NodeFilter.SHOW_COMMENT,{acceptNode:e=>{const t=(e.textContent||"").trim();return"/pp-scope"===t||t.startsWith("pp-scope:")?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}}),t=[];let s;for(;s=e.nextNode();)t.push(s);if(0===t.length)return;console.debug(`Found ${t.length} scope comments to remove`);let n=0;for(const e of t)try{e.parentNode&&(e.parentNode.removeChild(e),n++)}catch(e){console.error("Failed to remove scope comment:",e)}console.debug(`‚úÖ Successfully removed ${n} scope comments from DOM`)}static preCacheAllScopes(){const e=document.createTreeWalker(document.body,NodeFilter.SHOW_ELEMENT,null),t=[];let s;for(;s=e.nextNode();)t.push(s);for(const e of t)this.findScope(e);console.debug(`Pre-cached scopes for ${t.length} elements`)}static trackElement(e){this.trackedElements.add(e),this.trackedElements.size>=this.MAX_TRACKED_ELEMENTS&&this.scheduleCleanup();Date.now()-this.lastCleanup>this.CLEANUP_INTERVAL&&this.scheduleCleanup()}static scheduleCleanup(){this.cleanupScheduled||(this.cleanupScheduled=!0,requestIdleCallback(()=>{this.performCleanup(),this.cleanupScheduled=!1},{timeout:1e3}))}static performCleanup(){const e=[];let t=0;for(const s of this.trackedElements){if(t++,t%100==0&&!this.cleanupScheduled)break;document.contains(s)||e.push(s)}e.forEach(e=>{this.scopeCache.delete(e),this.trackedElements.delete(e)}),this.lastCleanup=Date.now(),e.length>0&&console.debug(`ScopeResolver cleanup: removed ${e.length} detached elements, ${this.trackedElements.size} elements remaining`)}static clearCache(){this.scopeCache=new WeakMap,this.commentCache=new WeakMap,this.trackedElements.clear(),this.cleanupScheduled=!1,this.lastCleanup=0}static invalidateElement(e){this.scopeCache.delete(e),this.trackedElements.delete(e)}static invalidateTree(e){this.invalidateElement(e);const t=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,null);let s;for(;s=t.nextNode();)this.invalidateElement(s)}static getCacheStats(){return{trackedElements:this.trackedElements.size,lastCleanup:this.lastCleanup,cleanupScheduled:this.cleanupScheduled}}static forceCleanup(){this.cleanupScheduled=!0,this.performCleanup(),this.cleanupScheduled=!1}}export class ExpressionValidator{static validate(e,t){const s=[],n=[];try{const t=parse(e,{ecmaVersion:2022,sourceType:"script"}),r=this.validateAST(t,e);s.push(...r.errors),n.push(...r.warnings);const i=this.validateSyntax(e);s.push(...i.errors),n.push(...i.warnings)}catch(e){s.push(`Invalid JavaScript syntax: ${e instanceof Error?e.message:String(e)}`)}return{valid:0===s.length,errors:s,warnings:n}}static validateAST(e,t){const s=[],n=[];return walk(e,{ConditionalExpression:e=>{const r=t.slice(e.consequent.start,e.consequent.end),i=this.validateBranch(r,"truthy");s.push(...i.errors),n.push(...i.warnings);const a=t.slice(e.alternate.start,e.alternate.end),o=this.validateBranch(a,"falsy");s.push(...o.errors),n.push(...o.warnings)}}),{errors:s,warnings:n}}static validateBranch(e,t){const s=[],n=[];try{return parse(e,{ecmaVersion:2022,sourceType:"script"}),{errors:s,warnings:n}}catch(r){const i=this.countQuotes(e);if(i.single%2!=0&&(s.push(`Unmatched single quotes in ternary ${t} branch: "${e}"`),this.hasTrailingOrLeadingQuote(e,"'"))){const t=this.suggestQuoteFix(e,"'");t&&s.push(`  Did you mean: ${t}`)}if(i.double%2!=0&&(s.push(`Unmatched double quotes in ternary ${t} branch: "${e}"`),this.hasTrailingOrLeadingQuote(e,'"'))){const t=this.suggestQuoteFix(e,'"');t&&s.push(`  Did you mean: ${t}`)}i.single%2==0&&i.double%2==0&&this.looksLikeUnquotedLiteral(e)&&n.push(`Value "${e}" in ternary ${t} branch may need quotes. Did you mean '${e}' or "${e}"?`)}return{errors:s,warnings:n}}static hasTrailingOrLeadingQuote(e,t){const s=e.startsWith(t),n=e.endsWith(t);return s&&!n||!s&&n}static suggestQuoteFix(e,t){return e.endsWith(t)&&!e.startsWith(t)?`${t}${e}`:e.startsWith(t)&&!e.endsWith(t)?`${e}${t}`:null}static looksLikeUnquotedLiteral(e){const t=e.trim();if(!t||this.isAlreadyQuoted(t))return!1;try{return parse(t,{ecmaVersion:2022,sourceType:"script"}),!1}catch{}return!RESERVED_WORDS.has(t)&&"true"!==t&&"false"!==t&&"null"!==t&&"undefined"!==t&&(!(!isNaN(Number(t))&&""!==t)&&(!/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(t)&&(!t.includes(".")&&!/\[.*\]/.test(t)&&(!/\(.*\)/.test(t)&&(!!t.includes("-")||(!!/\s/.test(t)||!!/[^a-zA-Z0-9_$.]/.test(t)))))))}static isAlreadyQuoted(e){return e.startsWith("'")&&e.endsWith("'")&&e.length>=2||e.startsWith('"')&&e.endsWith('"')&&e.length>=2}static countQuotes(e){let t=0,s=0,n=!1;for(let r=0;r<e.length;r++)n?n=!1:"\\"!==e[r]?("'"===e[r]&&t++,'"'===e[r]&&s++):n=!0;return{single:t,double:s}}static validateSyntax(e){const t=[],s=this.checkBrackets(e);s.valid||t.push(s.error);const n=this.checkParentheses(e);return n.valid||t.push(n.error),{errors:t,warnings:[]}}static checkBrackets(e){let t=0,s=!1,n="";for(let r=0;r<e.length;r++){const i=e[r],a=r>0?e[r-1]:"";if(s||"'"!==i&&'"'!==i?s&&i===n&&"\\"!==a&&(s=!1,n=""):(s=!0,n=i),!s&&("{"===i&&t++,"}"===i&&t--,t<0))return{valid:!1,error:"Unexpected closing bracket '}'"}}return 0!==t?{valid:!1,error:"Mismatched brackets - missing '}'"}:{valid:!0,error:""}}static checkParentheses(e){let t=0,s=!1,n="";for(let r=0;r<e.length;r++){const i=e[r],a=r>0?e[r-1]:"";if(s||"'"!==i&&'"'!==i?s&&i===n&&"\\"!==a&&(s=!1,n=""):(s=!0,n=i),!s&&("("===i&&t++,")"===i&&t--,t<0))return{valid:!1,error:"Unexpected closing parenthesis ')'"}}return 0!==t?{valid:!1,error:"Mismatched parentheses - missing ')'"}:{valid:!0,error:""}}}export class DOMCache{static instance;componentElementsCache=new LRUCache(100);scriptElementsCache=new LRUCache(50);templateElementsCache=new LRUCache(50);selectorCache=new LRUCache(200);elementComponentCache=new WeakMap;parentComponentCache=new WeakMap;contextComponentCache=new WeakMap;elementDepthCache=new WeakMap;elementChildrenCache=new WeakMap;cacheHits=0;cacheMisses=0;static CACHE_KEYS={COMPONENT_ELEMENTS:e=>`comp:${e}`,SCRIPTS:(e,t)=>`scripts:${e}:${t}`,TEMPLATES:(e,t)=>`templates:${e}:${t}`,SELECTOR:e=>`sel:${e}`};static getInstance(){return DOMCache.instance||(DOMCache.instance=new DOMCache),DOMCache.instance}queryComponentElements(e){const t=DOMCache.CACHE_KEYS.COMPONENT_ELEMENTS(e);if(this.componentElementsCache.has(t))return this.cacheHits++,this.componentElementsCache.get(t);this.cacheMisses++;const s=Array.from(document.querySelectorAll(`[${CONSTANTS.ATTR_PREFIXES.COMPONENT}="${e}"]`));return s.forEach(t=>{this.elementComponentCache.set(t,e)}),this.componentElementsCache.set(t,s),s}querySelectorAll(e){const t=DOMCache.CACHE_KEYS.SELECTOR(e);if(this.selectorCache.has(t))return this.cacheHits++,this.selectorCache.get(t);this.cacheMisses++;const s=Array.from(document.querySelectorAll(e));return this.selectorCache.set(t,s),s}getElementComponent(e){if(this.elementComponentCache.has(e))return this.cacheHits++,this.elementComponentCache.get(e);this.cacheMisses++;const t=e.getAttribute(CONSTANTS.ATTR_PREFIXES.COMPONENT);if(t)return this.elementComponentCache.set(e,t),t;let s=e.parentElement;for(;s;){const t=s.getAttribute(CONSTANTS.ATTR_PREFIXES.COMPONENT);if(t)return this.elementComponentCache.set(e,t),t;s=s.parentElement}return this.elementComponentCache.set(e,"app"),"app"}getContextComponent(e){if(this.contextComponentCache.has(e))return this.cacheHits++,this.contextComponentCache.get(e);this.cacheMisses++;const t=ScopeResolver.findScope(e);let s;return s=t?"app"===t?"app":t:this.getElementComponent(e),this.contextComponentCache.set(e,s),s}getParentOfComponent(e,t){if(this.parentComponentCache.has(t))return this.cacheHits++,this.parentComponentCache.get(t);if(this.cacheMisses++,"app"===e)return this.parentComponentCache.set(t,"app"),"app";let s=t;for(;s;){if(s.getAttribute(CONSTANTS.ATTR_PREFIXES.COMPONENT)===e)break;s=s.parentElement}if(!s)return this.parentComponentCache.set(t,"app"),"app";let n=s.parentElement;for(;n;){const e=n.getAttribute(CONSTANTS.ATTR_PREFIXES.COMPONENT);if(e)return this.parentComponentCache.set(t,e),e;n=n.parentElement}return this.parentComponentCache.set(t,"app"),"app"}getElementDepthCached(e){if(this.elementDepthCache.has(e))return this.cacheHits++,this.elementDepthCache.get(e);this.cacheMisses++;let t=0,s=e.parentElement;for(;s&&s!==document.body;)t++,s=s.parentElement;return this.elementDepthCache.set(e,t),t}getFirstComponentElement(e){const t=this.queryComponentElements(e);return t.length>0?t[0]:null}getComponentScripts(e,t){const s=DOMCache.CACHE_KEYS.SCRIPTS(e,t?.tagName||"global");if(this.scriptElementsCache.has(s))return this.cacheHits++,this.scriptElementsCache.get(s);this.cacheMisses++;let n=[];if(t){const e=t.querySelectorAll(`script[type="${CONSTANTS.SCRIPT_TYPE}"]`);for(const t of e)t instanceof HTMLScriptElement&&n.push(t)}else{const t=document.querySelectorAll(`script[type="${CONSTANTS.SCRIPT_TYPE}"]`);for(const s of t)if(s instanceof HTMLScriptElement){const t=s.getAttribute(CONSTANTS.ATTR_PREFIXES.COMPONENT);t!==e&&(t||s.closest(`[${CONSTANTS.ATTR_PREFIXES.COMPONENT}]`))||n.push(s)}}return this.scriptElementsCache.set(s,n),n}getComponentTemplates(e,t){const s=DOMCache.CACHE_KEYS.TEMPLATES(e,t?.tagName||"global");if(this.templateElementsCache.has(s))return this.cacheHits++,this.templateElementsCache.get(s);this.cacheMisses++;let n=[];if(t){const s=t.querySelectorAll("template[pp-for]");for(const t of s)t instanceof HTMLTemplateElement&&this.getElementComponent(t)===e&&n.push(t)}else{const t=document.querySelectorAll("template[pp-for]");for(const s of t)s instanceof HTMLTemplateElement&&this.getElementComponent(s)===e&&n.push(s)}return this.templateElementsCache.set(s,n),n}querySelector(e){const t=this.querySelectorAll(e);return t.length>0?t[0]:null}findElementForComponent(e,t){if("app"===t)return document.body;const s=this.queryComponentElements(t);return s.length>0?s[0]:null}invalidateCache(e){switch(e){case"components":this.componentElementsCache.clear();break;case"selectors":this.selectorCache.clear();break;case"scripts":this.scriptElementsCache.clear();break;case"templates":this.templateElementsCache.clear();break;default:this.clearAllCaches()}}invalidateByComponent(e){const t=DOMCache.CACHE_KEYS.COMPONENT_ELEMENTS(e);this.componentElementsCache.delete(t);const s=DOMCache.CACHE_KEYS.SCRIPTS(e,"global");this.scriptElementsCache.delete(s);const n=DOMCache.CACHE_KEYS.TEMPLATES(e,"global");this.templateElementsCache.delete(n),this.selectorCache.clear();this.queryComponentElements(e).forEach(e=>ScopeResolver.invalidateElement(e))}invalidateByPrefix(e){this.invalidateByComponent(e)}invalidateElement(e){this.elementComponentCache.delete(e),this.contextComponentCache.delete(e),this.parentComponentCache.delete(e),this.elementDepthCache.delete(e),this.elementChildrenCache.delete(e),ScopeResolver.invalidateElement(e)}clearAllCaches(){this.componentElementsCache.clear(),this.scriptElementsCache.clear(),this.templateElementsCache.clear(),this.selectorCache.clear(),this.elementComponentCache=new WeakMap,this.parentComponentCache=new WeakMap,this.contextComponentCache=new WeakMap,this.elementDepthCache=new WeakMap,this.elementChildrenCache=new WeakMap,ScopeResolver.clearCache()}getCacheStats(){const e=this.cacheHits+this.cacheMisses;return{componentElements:this.componentElementsCache.getStats(),scriptElements:this.scriptElementsCache.getStats(),templateElements:this.templateElementsCache.getStats(),selectors:this.selectorCache.getStats(),global:{size:0,maxSize:-1,hitRate:e>0?this.cacheHits/e*100:0,hits:this.cacheHits,misses:this.cacheMisses}}}resetStats(){this.cacheHits=0,this.cacheMisses=0}}class SubscriptionManager{subscriptions=new Map;elementSubscriptions=new WeakMap;keyIndex=new Map;cleanupQueue=new Set;cleanupScheduled=!1;addSubscription(e){this.subscriptions.set(e.id,e),e.element&&(this.elementSubscriptions.has(e.element)||this.elementSubscriptions.set(e.element,new Set),this.elementSubscriptions.get(e.element).add(e.id));for(const t of e.dependencies)this.keyIndex.has(t)||this.keyIndex.set(t,new Set),this.keyIndex.get(t).add(e.id)}removeSubscription(e){const t=this.subscriptions.get(e);if(t){if(t.cleanup&&"function"==typeof t.cleanup)try{t.cleanup()}catch(t){console.error(`Cleanup error for subscription ${e}:`,t)}if(this.subscriptions.delete(e),t.element){const s=this.elementSubscriptions.get(t.element);s&&(s.delete(e),0===s.size&&this.elementSubscriptions.delete(t.element))}for(const s of t.dependencies){const t=this.keyIndex.get(s);t&&(t.delete(e),0===t.size&&this.keyIndex.delete(s))}}}cleanupElement(e){const t=this.elementSubscriptions.get(e);t&&(t.forEach(e=>this.cleanupQueue.add(e)),this.scheduleCleanup())}scheduleCleanup(){this.cleanupScheduled||(this.cleanupScheduled=!0,queueMicrotask(()=>{this.processCleanupQueue(),this.cleanupScheduled=!1}))}processCleanupQueue(){for(const e of this.cleanupQueue)this.removeSubscription(e);this.cleanupQueue.clear()}getSubscription(e){return this.subscriptions.get(e)}getSubscriptionsForKey(e){return this.keyIndex.get(e)}getAllSubscriptions(){return new Map(this.subscriptions)}cleanupStaleSubscriptions(){const e=[];for(const[t,s]of this.subscriptions)s.element&&!document.contains(s.element)&&e.push(t);e.forEach(e=>this.removeSubscription(e))}getStats(){return{totalSubscriptions:this.subscriptions.size,elementSubscriptions:this.elementSubscriptions instanceof WeakMap?-1:0,keyIndexes:this.keyIndex.size}}}export class LRUCache{cache=new Map;maxSize;hits=0;misses=0;constructor(e){this.maxSize=e}keys(){return Array.from(this.cache.keys())}deleteByPrefix(e){let t=0;const s=[];return this.cache.forEach((t,n)=>{"string"==typeof n&&n.startsWith(e)&&s.push(n)}),s.forEach(e=>{this.cache.delete(e)&&t++}),t}getKeysByPrefix(e){const t=[];return this.cache.forEach((s,n)=>{"string"==typeof n&&n.startsWith(e)&&t.push(n)}),t}get(e){const t=this.cache.get(e);if(void 0!==t)return this.hits++,this.cache.delete(e),this.cache.set(e,t),t;this.misses++}set(e,t){if(this.cache.has(e))this.cache.delete(e);else if(this.cache.size>=this.maxSize){const e=this.cache.keys().next().value;void 0!==e&&this.cache.delete(e)}this.cache.set(e,t)}size(){return this.cache.size}has(e){return this.cache.has(e)}delete(e){return this.cache.delete(e)}clear(){this.cache.clear(),this.hits=0,this.misses=0}getStats(){const e=this.hits+this.misses;return{size:this.cache.size,maxSize:this.maxSize,hitRate:e>0?this.hits/e*100:0,hits:this.hits,misses:this.misses}}resetStats(){this.hits=0,this.misses=0}}export class MustacheParser{static EXPRESSION_CACHE=new LRUCache(1e3);static parseSpreadDirective(e){const t=e.replace(/^\s*\{\s*|\s*\}\s*$/g,""),s=this.parseSpreadParts(t),n=[],r=[];for(const e of s){const t=e.trim();if(t.startsWith("..."))n.push(t.substring(3).trim());else if(t.startsWith("{")&&t.endsWith("}")){const e=t.slice(1,-1).trim();if(e){const t=this.parseObjectProperties(e);r.push(t)}}else console.warn(`Invalid spread directive part: "${t}". Expected ...spread or {object}`)}return{spreads:n,objects:r}}static parseSpreadParts(e){const t=[];let s="",n=0,r=!1,i="",a=0;for(;a<e.length;){const o=e[a],c=a>0?e[a-1]:"";if(r||'"'!==o&&"'"!==o?r&&o===i&&"\\"!==c&&(r=!1,i=""):(r=!0,i=o),!r)if("{"===o)n++;else if("}"===o)n--;else if(","===o&&0===n){t.push(s.trim()),s="",a++;continue}s+=o,a++}return s.trim()&&t.push(s.trim()),t}static parseObjectProperties(e){const t=[],s=this.parseObjectParts(e);for(const e of s){const s=e.trim(),n=this.findPropertySeparator(s);if(-1!==n){const e=s.substring(0,n).trim().replace(/['"]/g,""),r=s.substring(n+1).trim();t.push({key:e,value:r})}else console.warn(`Invalid object property: "${s}". Expected key: value format.`)}return t}static parseObjectParts(e){const t=[];let s="",n=0,r=!1,i="";for(let a=0;a<e.length;a++){const o=e[a],c=a>0?e[a-1]:"";if(r||'"'!==o&&"'"!==o?r&&o===i&&"\\"!==c&&(r=!1,i=""):(r=!0,i=o),!r)if("{"===o||"["===o||"("===o)n++;else if("}"===o||"]"===o||")"===o)n--;else if(","===o&&0===n){t.push(s.trim()),s="";continue}s+=o}return s.trim()&&t.push(s.trim()),t}static findPropertySeparator(e){let t=0,s=!1,n="";for(let r=0;r<e.length;r++){const i=e[r],a=r>0?e[r-1]:"";if(s||'"'!==i&&"'"!==i?s&&i===n&&"\\"!==a&&(s=!1,n=""):(s=!0,n=i),!s)if("{"===i||"["===i||"("===i)t++;else if("}"===i||"]"===i||")"===i)t--;else if(":"===i&&0===t)return r}return-1}static decodeEntities=e=>{const t=document.createElement("textarea");t.innerHTML=e;let s=t.value;for(;s.includes("&");){t.innerHTML=s;const e=t.value;if(e===s)break;s=e}return s};static parse(e){if(MustacheParser.EXPRESSION_CACHE.has(e))return MustacheParser.EXPRESSION_CACHE.get(e);const t=MustacheParser.parseContentWithNesting(e);return MustacheParser.EXPRESSION_CACHE.set(e,t),t}static parseContentWithNesting(e){const t=[],s=e.length;let n=0,r=0;for(;n<s;){if("{"===e[n]){n>r&&t.push({type:"static",content:e.substring(r,n),expression:null});const s=this.extractNestedExpression(e,n);-1!==s.endIndex&&s.expression&&this.isValidExpression(s.expression)?(t.push({type:"expression",content:e.substring(n,s.endIndex+1),expression:s.expression.trim()}),n=s.endIndex+1,r=n):n++}else n++}return r<s&&t.push({type:"static",content:e.substring(r),expression:null}),t}static isValidExpression(e){const t=e.trim();if(!t)return!1;try{const e=parse(t,{ecmaVersion:2022,sourceType:"script"});if("Program"!==e.type)return!1;const s=e.body;if(!s||0===s.length)return!1;const n=s[0];if("ExpressionStatement"!==n.type)return!1;const r=n.expression;return"ObjectExpression"!==r.type&&"SequenceExpression"!==r.type}catch(e){try{const e=parse(`(${t})`,{ecmaVersion:2022,sourceType:"script"}).body;if(e&&e.length>0&&"ExpressionStatement"===e[0].type)return!0}catch(e){return!1}return!1}}static extractNestedExpression(e,t){let s=1,n=t+1,r=!1,i="",a=!1;for(;n<e.length&&s>0;){const t=e[n],o=n>0?e[n-1]:"";r||'"'!==t&&"'"!==t?r&&t===i&&"\\"!==o&&(r=!1,i=""):(r=!0,i=t),r||"`"!==t||"\\"===o||(a=!a),r||a||("{"===t?s++:"}"===t&&s--),n++}if(0===s){const s=e.slice(t+1,n-1);if(s.trim()){const t=this.checkForMismatchedQuotes(s);t.hasIssue&&(console.error("\n‚ùå Malformed expression detected during parsing:"),console.error(`   Expression: ${s}`),console.error(`   Issue: ${t.message}`),console.error(`   Full content: ${e}`),console.error("   üí° Hint: Check your quotes - strings must be properly quoted\n"))}return{endIndex:n-1,expression:s}}return console.warn("\n‚ö†Ô∏è  Failed to extract mustache expression - unclosed braces"),console.warn(`   Content: ${e}`),console.warn(`   Starting at position: ${t}\n`),{endIndex:-1,expression:""}}static checkForMismatchedQuotes(e){let t=0,s=0,n=!1;for(let r=0;r<e.length;r++)n?n=!1:"\\"!==e[r]?("'"===e[r]&&t++,'"'===e[r]&&s++):n=!0;return t%2!=0?{hasIssue:!0,message:`Unmatched single quotes (found ${t})`}:s%2!=0?{hasIssue:!0,message:`Unmatched double quotes (found ${s})`}:{hasIssue:!1,message:""}}static isSingleExpression(e){const t=MustacheParser.parseContentWithNesting(e);return 1===t.length&&"expression"===t[0].type?t[0].expression:null}static extractExpressions(e){const t=MustacheParser.parseContentWithNesting(e),s=t.filter(e=>"expression"===e.type).map(e=>e.expression).filter(e=>e);return t.some(e=>"expression"===e.type)&&0===s.length&&(console.error("\n‚ùå Failed to extract expressions from content:"),console.error(`   Content: ${e}`),console.error(`   Parsed ${t.length} parts, but extracted 0 expressions`),console.error("   This usually means malformed mustache syntax\n")),s}}class EventBus{listeners=new Map;on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.off(e,t)}off(e,t){this.listeners.get(e)?.delete(t)}emit(e,...t){const s=this.listeners.get(e);s&&s.forEach(s=>{try{s(...t)}catch(t){console.error(`Event listener error for ${e}:`,t)}})}}export class StateManager{subscriptionManager=new SubscriptionManager;stateStore={};updateQueue=new Set;isUpdating=!1;eventBus=new EventBus;contextCache=new Map;previousValues=new Map;originalStateStore={};domUpdateCallbacks=[];domUpdateScheduled=!1;suspendNotifications=!1;constructor(){this.setupGlobalStateProxy(),setInterval(()=>{this.subscriptionManager.cleanupStaleSubscriptions()},3e4)}suspendSubscriptions(){this.suspendNotifications=!0}resumeSubscriptions(){this.suspendNotifications=!1}static findExistingStateKey(e,t,s){return[`${t}.${e}`,`app.${e}`,e].find(e=>e in s)||null}clearSubscriptions(){const e=this.subscriptionManager.getAllSubscriptions();for(const[t,s]of e)if(s.cleanup&&"function"==typeof s.cleanup)try{s.cleanup()}catch(e){console.error(`‚ùå [StateManager] Cleanup error for subscription ${t}:`,e)}for(const[t]of e)this.subscriptionManager.removeSubscription(t);this.updateQueue.clear()}clearComponentSubscriptions(e){const t=this.subscriptionManager.getAllSubscriptions();for(const[s,n]of t)n.component===e&&this.subscriptionManager.removeSubscription(s)}clearState(){Object.keys(this.stateStore).forEach(e=>{delete this.stateStore[e],delete this.originalStateStore[e]}),this.previousValues.clear(),this.updateQueue.clear(),this.contextCache.clear()}clearComponentState(e){Object.keys(this.stateStore).filter(t=>t.startsWith(`${e}.`)).forEach(e=>{delete this.stateStore[e],delete this.originalStateStore[e],this.previousValues.delete(e)})}onDOMUpdateComplete(e){this.domUpdateCallbacks.push(e),this.domUpdateScheduled||(this.domUpdateScheduled=!0,requestAnimationFrame(()=>{requestAnimationFrame(()=>{const e=[...this.domUpdateCallbacks];this.domUpdateCallbacks=[],this.domUpdateScheduled=!1,e.forEach(e=>{try{e()}catch(e){console.error("DOM update callback error:",e)}})})}))}setInitialState(e,t){if(this.previousValues.set(e,void 0),this.originalStateStore[e]=t,this.previousValues.size>100){const e=this.previousValues.keys().next().value;"string"==typeof e&&this.previousValues.delete(e)}}batchStateUpdates(e){const t=this.isUpdating;this.isUpdating=!0;try{return e()}finally{this.isUpdating=t,!this.isUpdating&&this.updateQueue.size>0&&this.scheduleFlush()}}invalidateContextCache(){this.contextCache.clear()}setupGlobalStateProxy(){this.originalStateStore=this.stateStore,this.stateStore=new Proxy(this.stateStore,{set:(e,t,s,n)=>{const r=e[t],i=Reflect.set(e,t,s,n);return r!==s&&this.notifySubscribers(t),i},get:(e,t)=>Reflect.get(e,t)})}notifySubscribers(e){if(this.updateQueue.add(e),e.includes(".")){const t=e.split(".")[0];this.updateQueue.add(t)}this.suspendNotifications||(this.eventBus.emit("stateChanged",e),this.notifyPathBasedSubscribers(e),this.isUpdating||this.scheduleFlush())}notifyPathBasedSubscribers(e){const t=this.stateStore[e],s=this.previousValues?.get(e),n=this.subscriptionManager.getAllSubscriptions();for(const[r,i]of n)for(const n of i.dependencies)if(this.isPathDependency(n)&&n.startsWith(e+".")){const r=n.substring(e.length+1),i=this.getPathValue(s,r),a=this.getPathValue(t,r);this.deepEqual(i,a)||this.updateQueue.add(n)}}isPathDependency(e){return e.includes(".")&&e.split(".").length>1}getPathValue(e,t){if(!e||"object"!=typeof e)return;const s=t.split(".");let n=e;for(const e of s){if(null==n)return;if(Array.isArray(n))return"length"===e?n.length:n.map(t=>t?.[e]).filter(e=>void 0!==e);n=n[e]}return n}deepEqual(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every((e,s)=>this.deepEqual(e,t[s]));if("object"==typeof e&&"object"==typeof t){const s=Object.keys(e),n=Object.keys(t);return s.length===n.length&&s.every(s=>this.deepEqual(e[s],t[s]))}return!1}scheduleFlush=debounce(()=>{this.flushUpdates()},CONSTANTS.DEBOUNCE_MS);flushUpdates(){if(!this.isUpdating){this.isUpdating=!0;try{const e=new Set,t=this.subscriptionManager.getSubscriptionsForKey("*");if(t&&t.size>0&&this.updateQueue.size>0)for(const e of t){const t=this.subscriptionManager.getSubscription(e);if(!t)continue;if(t.element&&!document.contains(t.element)){this.subscriptionManager.removeSubscription(e);continue}const s=t.element??document.body;try{const e=Array.from(this.updateQueue)[0];t.callback(s,{key:e})}catch(e){console.error("Wildcard subscription callback failed:",e)}}for(const t of this.updateQueue){if(e.has(t))continue;e.add(t);const s=this.subscriptionManager.getSubscriptionsForKey(t);if(s)for(const e of s){const s=this.subscriptionManager.getSubscription(e);if(!s)continue;const n=s.element??document.body;try{s.callback(n,{key:t})}catch(e){console.error("Subscription callback failed:",e)}}}}finally{this.updateQueue.clear(),this.isUpdating=!1}}}getState(){return this.stateStore}setState(e,t){if(this.previousValues.set(e,this.stateStore[e]),this.stateStore[e]=t,this.previousValues.size>100){const e=this.previousValues.keys().next().value;"string"==typeof e&&this.previousValues.delete(e)}}hasState(e){return e in this.originalStateStore}addSubscription(e){this.subscriptionManager.addSubscription(e)}removeSubscription(e){this.subscriptionManager.removeSubscription(e)}onStateChange(e){return this.eventBus.on("stateChanged",e)}batch(e){const t=this.isUpdating;this.isUpdating=!0;try{return e()}finally{this.isUpdating=t,!this.isUpdating&&this.updateQueue.size&&this.flushUpdates()}}getSubscriptions(){return this.subscriptionManager.getAllSubscriptions()}getKeyIndex(){const e=new Map,t=this.subscriptionManager.getAllSubscriptions();for(const[s,n]of t)for(const t of n.dependencies)e.has(t)||e.set(t,new Set),e.get(t).add(s);return e}destroy(){this.clearState(),this.clearSubscriptions(),this.contextCache.clear(),this.previousValues.clear(),this.domUpdateCallbacks=[]}}export class ExpressionEvaluator{expressionCache=new LRUCache(CONSTANTS.MAX_CACHE_SIZE);dependencyCache=new LRUCache(CONSTANTS.MAX_CACHE_SIZE);commonExpressionsCache=new LRUCache(100);dependencyParser=new DependencyParser;static CACHE_KEYS={EXPRESSION:(e,t)=>`expr:${e}:${t}`,DEPENDENCY:(e,t)=>`deps:${e}:${t}`,COMMON:e=>`common:${e}`};constructor(){this.precompileCommonExpressions()}normalizeExpression(e){return e.replace(/\r\n/g," ").replace(/\r/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}precompileCommonExpressions(){["true","false","null","undefined"].forEach(e=>{const t={fn:new Function("return "+e),contextMap:new Map,dependencies:[e],timestamp:Date.now(),hitCount:0},s=ExpressionEvaluator.CACHE_KEYS.COMMON(e);this.commonExpressionsCache.set(s,t)})}extractDependencies(e,t,s){const n=this.normalizeExpression(e),r=ExpressionEvaluator.CACHE_KEYS.DEPENDENCY(t,n);let i=this.dependencyCache.get(r);return i||(i=this.dependencyParser.extract(n,t,s),this.dependencyCache.set(r,i),i)}evaluateExpression(e,t,s){const n=this.normalizeExpression(e),r=ExpressionEvaluator.CACHE_KEYS.COMMON(n);let i=this.commonExpressionsCache.get(r);if(i){i.hitCount++;try{return i.fn()}catch(e){return void console.error(`Common expression evaluation failed: "${n}"`,e)}}const a=ExpressionEvaluator.CACHE_KEYS.EXPRESSION(s,n);i=this.expressionCache.get(a);const o=this.transformContextForEvaluation(t,n);i&&!this.isStale(i)||(i=this.compileExpression(n,o,s),this.expressionCache.set(a,i)),i.hitCount++;try{const e=this.buildArguments(i.contextMap,o);return i.fn(...e)}catch(e){return console.error(`Expression evaluation failed: "${n}"`,e),void console.error("Available context:",Object.keys(o))}}transformContextForEvaluation(e,t){const s=!!t&&expressionNeedsValueExtraction(t),n={};for(const[t,r]of Object.entries(e))isStateGetter(r)?n[t]=extractStateValueSmart(r,{forComparison:s}):n[t]=r;return n}compileExpression(e,t,s){const n=this.prepareSafeContext(t),r=new Map,i=[];Object.keys(n).forEach((e,t)=>{r.set(e,t),i.push(e)});const a=this.dependencyParser.extract(e,s);return{fn:new Function(...i,`return (${e})`),contextMap:r,dependencies:a,timestamp:Date.now(),hitCount:0}}buildArguments(e,t){const s=new Array(e.size);for(const[n,r]of e)s[r]=t[n];return s}isStale(e){return Date.now()-e.timestamp>3e5}prepareSafeContext(e){const t={};for(const[s,n]of Object.entries(e))!RESERVED_WORDS.has(s)&&this.isValidJavaScriptIdentifier(s)&&(t[s]=n);return t}isValidJavaScriptIdentifier(e){return/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(e)&&!RESERVED_WORDS.has(e)}invalidateCache(e){switch(e){case"expressions":this.expressionCache.clear();break;case"dependencies":this.dependencyCache.clear();break;case"common":this.commonExpressionsCache.clear(),this.precompileCommonExpressions();break;case"parser":this.dependencyParser.clearCache();break;default:this.clearAllCaches()}}invalidateByComponent(e){this.expressionCache.deleteByPrefix(`expr:${e}:`),this.dependencyCache.deleteByPrefix(`deps:${e}:`)}clearAllCaches(){this.expressionCache.clear(),this.dependencyCache.clear(),this.commonExpressionsCache.clear(),this.dependencyParser.clearCache(),this.precompileCommonExpressions()}getCacheStats(){return{expressions:this.expressionCache.getStats(),dependencies:this.dependencyCache.getStats(),commonExpressions:this.commonExpressionsCache.getStats(),dependencyParser:this.getDependencyParserStats()}}getDependencyParserStats(){if(this.dependencyParser.getCacheSize){return{size:this.dependencyParser.getCacheSize(),maxSize:500,hitRate:0,hits:0,misses:0}}return{size:0,maxSize:0,hitRate:0,hits:0,misses:0}}cleanupStaleExpressions(){let e=0;return this.expressionCache.keys().forEach(t=>{const s=this.expressionCache.get(t);s&&this.isStale(s)&&(this.expressionCache.delete(t),e++)}),e}}class DependencyParser{parseCache=new LRUCache(500);extract(e,t,s){const n=this.normalizeExpression(e),r=`${t}:${n}`;if(this.parseCache.has(r))return this.parseCache.get(r);const i=this.parseExpression(n,t,s);return this.parseCache.set(r,i),i}normalizeExpression(e){return e.replace(/\r\n/g," ").replace(/\r/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}parseExpression(e,t,s){const n=this.extractIdentifiers(e),r=[],i=s?.getState()||{};for(const e of n){if(RESERVED_WORDS.has(e))continue;const s=e.indexOf("."),n=-1===s?e:e.substring(0,s),a=StateManager.findExistingStateKey(n,t,i);if(a)r.push(a);else{const e="app"===t?[`app.${n}`]:[`${t}.${n}`,`app.${n}`];r.push(...e)}if(-1!==s){const e="app"===t?[`app.${n}`]:[`${t}.${n}`,`app.${n}`];r.push(...e)}}return Array.from(new Set(r))}extractIdentifiers(e){const t=[];let s=0;for(;s<e.length;){const n=e[s];if("'"!==n)if('"'!==n)if("`"!==n){if(this.isIdentifierStart(n)){const n=this.extractIdentifier(e,s);t.push(n.value),s=n.endIndex;continue}s++}else s=this.skipTemplateLiteral(e,s,t);else s=this.skipString(e,s,'"');else s=this.skipString(e,s,"'")}return t}skipString(e,t,s){let n=t+1;for(;n<e.length&&e[n]!==s;)"\\"===e[n]&&n++,n++;return n+1}skipTemplateLiteral(e,t,s){let n=t+1;for(;n<e.length&&"`"!==e[n];){if("$"===e[n]&&n+1<e.length&&"{"===e[n+1]){n+=2;let t=1;for(;n<e.length&&t>0;){const r=e[n];if('"'!==r&&"'"!==r){if("{"===r?t++:"}"===r&&t--,t>0&&this.isIdentifierStart(r)){const t=this.extractIdentifier(e,n);s.push(t.value),n=t.endIndex-1}n++}else n=this.skipString(e,n,r)}continue}"\\"===e[n]&&n++,n++}return n+1}extractIdentifier(e,t){let s=t;for(;s<e.length&&(this.isIdentifierPart(e[s])||"."===e[s]);)s++;return{value:e.substring(t,s),endIndex:s}}isIdentifierStart(e){return/[a-zA-Z_$]/.test(e)}isIdentifierPart(e){return/[a-zA-Z0-9_$]/.test(e)}clearCache(){this.parseCache.clear()}getCacheSize(){return this.parseCache.cache.size}}export class PP{hydrationStarted=!1;hydrationDone=!1;static instance=null;initialized=!1;stateManager=new StateManager;expressionEvaluator=new ExpressionEvaluator;componentManager=new ComponentManager(this.stateManager);domBindingManager=new DOMBindingManager(this.stateManager,this.componentManager,this.expressionEvaluator);hydrationCallbacks=new Set;portalManager=new PortalManager;hydrationResolve;hydrationPromise;portalHydrationPromises=new Set;portalHydrationResolvers=new Map;lifecycleManager=new LifecycleManager;pendingEffects=[];onceEffectCleanups=new Map;constructor(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.initialize()):setTimeout(()=>this.initialize(),0),this.hydrationPromise=new Promise(e=>this.hydrationResolve=e)}async initialize(){if(this.initialized)return;this.initialized=!0,this.markHydrationStart();const e=this.domBindingManager.loopManager;return this.componentManager.setExpressionEvaluator(this.expressionEvaluator),this.portalManager.setDependencies(this.componentManager,this.domBindingManager,this.stateManager,this),ScopeResolver.preCacheAllScopes(),this.lifecycleManager.markPhaseComplete(HydrationPhase.NOT_STARTED),await this.lifecycleManager.executeHook("beforeScripts"),this.componentManager.executePhpScripts(document.body),await this.lifecycleManager.executeHook("afterScripts"),this.lifecycleManager.markPhaseComplete(HydrationPhase.SCRIPTS_EXECUTING),e&&e.setHydrating(!1),await this.lifecycleManager.executeHook("beforeLoops"),await this.processAllLoops(),await this.lifecycleManager.executeHook("afterLoops"),this.lifecycleManager.markPhaseComplete(HydrationPhase.LOOPS_PROCESSING),await this.lifecycleManager.executeHook("beforeEffects"),await this.runPendingEffects(),await this.lifecycleManager.executeHook("afterEffects"),this.lifecycleManager.markPhaseComplete(HydrationPhase.EFFECTS_RUNNING),await this.lifecycleManager.executeHook("beforePortals"),await Promise.all(Array.from(this.portalHydrationPromises)),await this.lifecycleManager.executeHook("afterPortals"),this.lifecycleManager.markPhaseComplete(HydrationPhase.PORTALS_RENDERING),Promise.resolve().then(()=>{requestAnimationFrame(()=>{this.lifecycleManager.markPhaseComplete(HydrationPhase.COMPLETE),this.hydrationStarted=!1,this.hydrationDone=!0,this.markHydrated(),this.scheduleCommentCleanup(),this.reconnectObservers()})})}async processAllLoops(){this.domBindingManager.processElement(document.body,!0),this.domBindingManager.processPendingBindings();const e=this.domBindingManager.loopManager;e&&await e.waitForAllLoopsProcessed()}async runPendingEffects(){const e=[...this.pendingEffects];this.pendingEffects=[],this.stateManager.suspendSubscriptions();try{this.stateManager.batch(()=>{for(const t of e)try{t()}catch(e){console.error("[PPHP] Effect execution error:",e)}}),await new Promise(e=>setTimeout(e,0))}finally{this.stateManager.resumeSubscriptions(),this.stateManager.flushUpdates()}const t=this.domBindingManager.loopManager;t&&await this.triggerLoopUpdatesFromEffects(t)}async triggerLoopUpdatesFromEffects(e){const t=e.getAllLoops();for(const[s,n]of t)try{e.renderLoop(n,n.iterableExpr)}catch(e){console.error(`[PPHP] Error updating loop "${n.expression}":`,e)}await new Promise(e=>setTimeout(e,0))}onPhase(e,t){document.addEventListener(`pp:phase:${e}`,t)}waitForPhase(e){return this.lifecycleManager.waitForPhase(e)}registerLifecycleHooks(e){this.lifecycleManager.registerHooks(e)}disconnectObservers(){this.domBindingManager&&this.domBindingManager.pauseObserver()}reconnectObservers(){this.domBindingManager&&this.domBindingManager.resumeObserver()}scheduleCommentCleanup(){const e=()=>{try{ScopeResolver.removeScopeComments(),console.debug("‚úÖ Scope comments cleaned up")}catch(e){console.error("Failed to remove scope comments:",e)}};"requestIdleCallback"in window?requestIdleCallback(e,{timeout:5e3}):setTimeout(e,100)}createPortal(e,t,s){const n=this.portalManager.createPortal(e,t,s),r=new Promise(e=>{this.portalHydrationResolvers.set(n,e)});return this.portalHydrationPromises.add(r),r.finally(()=>{this.portalHydrationPromises.delete(r),this.portalHydrationResolvers.delete(n)}),n}removePortal(e){return this.markPortalHydrated(e),this.portalManager.removePortal(e)}hasPortal(e){return this.portalManager.hasPortal(e)}getPortal(e){return this.portalManager.getPortal(e)}markPortalHydrated(e){const t=this.portalHydrationResolvers.get(e);t&&t()}updatePortal(e,t,s){return this.portalManager.updatePortal(e,t,s)}cleanup(){this.disconnectObservers();const e=this.domBindingManager.loopManager;if(e)try{e.destroy()}catch(e){console.error("‚ùå [Cleanup] Error destroying loop manager:",e)}const t=this.componentManager?Array.from(this.componentManager.getRegisteredComponents()):[];for(const[e,t]of this.onceEffectCleanups)try{t()}catch(t){console.error(`‚ùå [Cleanup] Error cleaning up once effect ${e}:`,t)}this.onceEffectCleanups.clear();for(const e of t)window[e]&&delete window[e];this.portalHydrationPromises.clear(),this.portalHydrationResolvers.clear(),this.portalManager.destroy(),this.domBindingManager.destroy(),this.componentManager.destroy(),this.stateManager.clearState(),this.stateManager.clearSubscriptions(),this.expressionEvaluator.clearAllCaches(),this.hydrationCallbacks.clear(),ScopeResolver.clearCache(),this.hydrationStarted=!1,this.hydrationDone=!1,this.initialized=!1;ScopeChainRegistry.getInstance().clear()}ref(e=null){return{current:e}}async hydrated(){await Promise.all([this.hydrationPromise,...Array.from(this.portalHydrationPromises)])}onHydrated(e){this.hydrationDone?queueMicrotask(e):this.hydrationCallbacks.add(e)}markHydrationStart(){this.hydrationStarted=!0,this.hydrationDone=!1,document.dispatchEvent(new CustomEvent("pp:hydrationStart"))}get isHydrated(){return this.hydrationDone}get isHydrating(){return this.hydrationStarted&&!this.hydrationDone}markHydrated(){this.hydrationResolve();for(const e of this.hydrationCallbacks)try{e()}catch(e){console.error("‚ùå [PPHP] Hydration callback error:",e)}this.hydrationCallbacks.clear(),document.dispatchEvent(new CustomEvent("pp:hydrated",{detail:{at:performance.now()}}))}state(e,t){const s=this.componentManager.getCurrentComponent();let n,r;"string"==typeof e&&2===arguments.length?(n=e,r=t):"string"==typeof e&&1===arguments.length?this.looksLikeVariableName(e)?(n=e,r=void 0):(console.warn("pp.state() called with string that doesn't look like variable name:",e),n="unknownState",r=e):(console.warn("pp.state() called without explicit key - this should be handled by AST transformation"),n="unknownState",r=e),isStateGetter(r)&&(r=extractStateValue(r));let i=`${s}.${n}`;this.stateManager.hasState(i)||this.stateManager.setInitialState(i,r);const a=()=>this.stateManager.getState()[i],o=new Proxy(a,{get(e,t,s){if("__pphp_key"===t||"__pphp_fullKey"===t||"__pphp_component"===t||"value"===t||"valueOf"===t||"toString"===t)return Reflect.get(e,t,s);const n=e();if(null!=n){if(t in Object(n)){const e=n[t];return"function"==typeof e?e.bind(n):e}return Reflect.get(e,t,s)}},has(e,t){if("__pphp_key"===t||"__pphp_fullKey"===t||"__pphp_component"===t||"value"===t||"valueOf"===t||"toString"===t)return Reflect.has(e,t);const s=e();return null!=s&&t in Object(s)||Reflect.has(e,t)},apply:(e,t,s)=>Reflect.apply(e,t,s)});Object.defineProperty(o,"__pphp_key",{value:n,enumerable:!1,writable:!1}),Object.defineProperty(o,"__pphp_fullKey",{value:i,enumerable:!1,writable:!1}),Object.defineProperty(o,"__pphp_component",{value:s,enumerable:!1,writable:!1}),Object.defineProperty(o,"value",{get:()=>this.stateManager.getState()[i],enumerable:!0,configurable:!0}),a.valueOf=()=>this.stateManager.getState()[i],a.toString=()=>valueToString(this.stateManager.getState()[i]);const c=e=>{const t=this.stateManager.getState()[i],s="function"==typeof e?e(t):e;this.stateManager.setState(i,s)};return this.createComponentScopedGlobals(s,n,o,c),[o,c]}looksLikeVariableName(e){return/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(e)&&e.length<=50&&!e.includes(" ")&&!RESERVED_WORDS.has(e)}effect(e,t){const s=`effect_${Date.now()}_${Math.random()}`,n=this.componentManager.getCurrentComponent();let r,i,a,o=!1,c=!1,l=!1;if(1===arguments.length)i="always",a={immediate:!0};else if(Array.isArray(t)){const e=this.extractDependencyNames(t,n);0===e.length?(i="once",a={deps:[],immediate:!0}):(i="deps",a={deps:e,immediate:!0})}else{const e={immediate:!0,...t||{}};if(e.deps)if(0===e.deps.length)i="once",a={deps:[],immediate:e.immediate};else{const t=this.extractDependencyNames(e.deps,n);i="deps",a={deps:t,immediate:e.immediate}}else i="always",a={immediate:e.immediate}}const h=()=>{if(!o&&!c){if(c=!0,l=!0,r&&"function"==typeof r)try{r(),r=void 0}catch(e){console.error(`‚ùå [Effect ${s}] Cleanup error:`,e)}try{const t=e();r="function"==typeof t?t:void 0}catch(e){console.error(`‚ùå [Effect ${s}] Error:`,e)}finally{c=!1}}},p=()=>{o||c||this.isHydrating&&l&&"always"===i||("once"===i&&this.isHydrating?this.pendingEffects.push(h):"once"!==i?!this.isHydrating||"always"!==i&&"deps"!==i||l?this.stateManager.onDOMUpdateComplete(h):this.pendingEffects.push(h):h())},u=()=>{if(!o&&(o=!0,"function"==typeof r))try{r(),r=void 0}catch(e){console.error(`‚ùå [Effect ${s}] Cleanup error:`,e)}};switch(i){case"always":this.stateManager.addSubscription({id:s,selector:"",dependencies:new Set(["*"]),callback:p,component:n,cleanup:u});break;case"once":!1!==a.immediate&&(this.isHydrating?this.pendingEffects.push(h):h()),this.onceEffectCleanups||(this.onceEffectCleanups=new Map),this.onceEffectCleanups.set(s,u);break;case"deps":const e=this.resolveDependencies(a.deps,n);e.length&&this.stateManager.addSubscription({id:s,selector:"",dependencies:new Set(e),callback:p,component:n,cleanup:u})}return"once"!==i&&!1!==a.immediate&&(this.isHydrating?this.pendingEffects.push(h):p()),()=>{u(),this.stateManager.removeSubscription(s),this.onceEffectCleanups&&this.onceEffectCleanups.delete(s)}}extractDependencyNames(e,t){const s=[];for(const t of e)"string"==typeof t?s.push(t):"function"==typeof t&&t.__pphp_key?s.push(t.__pphp_key):console.warn("Invalid dependency in effect:",t);return s.filter(Boolean)}resolveDependencies(e,t){const s=[],n=this.stateManager.getState();for(const r of e)if(r.includes(".")){const e=r.split("."),i=e[0],a=e.slice(1).join("."),o=this.componentManager.getPropDependencies(i,t);if(o.length>0)s.push(...o);else{const e=StateManager.findExistingStateKey(i,t,n);e?s.push(`${e}.${a}`):s.push(`${t}.${r}`)}}else{const e=this.componentManager.getPropDependencies(r,t);if(e.length>0)s.push(...e);else{const e=StateManager.findExistingStateKey(r,t,n);e?s.push(e):s.push(`${t}.${r}`)}}return Array.from(new Set(s))}createComponentScopedGlobals(e,t,s,n){window[e]||(window[e]={},this.componentManager.registerComponent(e));const r=`set${capitalize(t)}`;window[e][t]=s,window[e][r]=n,window[e][`${t}Getter`]=s}static resetInstance(){this.instance&&(this.instance.destroy(),this.instance=null)}destroy(){this.cleanup(),this.initialized=!1,this.hydrationDone=!1}}